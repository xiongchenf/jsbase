<!--?php use hughcube\helpers\Json; ?-->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=0" />
    <title>支付中</title>
    <style>
    #app {
        padding: 60px 0 40px;
        margin: 0 10px;
        text-align: center;
        height: 100%;
        border-bottom: 1px solid #f5f5f5;
    }

    img {
        display: inline-block;
    }

    p {
        font-size: 14px;
        margin-top: 0.2em;
    }

    .btn {
        padding: 8px 25px;
        color: #fff;
        background: #4ec2fc;
        text-decoration: none;
        -webkit-border-radius: 4px;
        -moz-border-radius: 4px;
        border-radius: 4px;
        position: relative;
        top: 20px;
        font-size: 14px;
        margin: 0 10px;
    }

    h3 {
        margin-top: 1em;
    }

    #integral {
        text-align: center;
        padding-top: 90px;
        height: 40px;
        width: 100%;
    }

    #integral p {
        display: block;
        margin: 0 0;
        padding: 5px 0;
    }
    </style>
    <script>
    window.onerror = function(err) {
        alert(JSON.stringify(err))
    }
    </script>
</head>

<body>
    <button style="position: fixed; z-index:+100;left: 10px;top: 10px;background: #f9f9f9;padding: 10px;" onclick="location.reload()">reload</button>
    <div id="container">
        <div id="app">正在支付积分请稍后</div>
        <div id="integral">
            
        </div>
    </div>
    <script src="https://img.caibeitv.com/caibeitv/html/company/dev/js/neigou_jsbridge.js"></script>
    <script>
    //var $data = <?////= Json::encode($data); ?>//;
    var $data = {
        "out_trade_no": "1539163562658613",
        "order_id": "201810101725585714",
        "account_no": "S40ZXYQ6rvSfjzMV",
        "total_fee": "3146",
        "notify_url": "http://test.neigou.com/openapi/ectools_payment/parse/wap/wap_payment_plugin_mcaibei_server/callback/",
        "callback_url": "http://test.neigou.com/openapi/ectools_payment/parse/wap/wap_payment_plugin_mcaibei/callback/",
        "mer_id": "123",
        "sub_time": "1539163559",
        "expir_time": "1539165939",
        "sign": "d0a362eda1cb25a55ca9858f7a3acac7",
        "integral_count": "3146"
    };
    var Api = {
            pay: '/neigou/pay.json',
            home: '/neigou/login-url.json'
        },
        app = document.getElementById('app'),
        integral = document.getElementById('integral'),
        total_fee = $data['total_fee'],
        integral_count = $data['integral_count'],
        homeUrl = "",
        paying = '<div><img src="https://img.caibeitv.com/static_project/static_image/neigou_loading.gif" alt=""><p>正在支付<span style="color:#4ec2fc">' + integral_count + '</span>积分请稍后</p><div>',
        lack = '<div><img src="https://img.caibeitv.com/static_project/static_image/neigou_integral_lack.png" alt=""><h3>支付失败</h3><p>积分不足，请获取积分后再试！</p><a onclick="toHome()" class="btn" href="javascript:">商城首页</a><a class="btn" href="javascript:">查看订单</a><div>',
        error = '<div><img src="https://img.caibeitv.com/static_project/static_image/neigou_network_error.png" alt=""><h3>支付失败</h3><p>网络异常，请检查网络是否通畅！</p><a onclick="toHome()" class="btn" href="javascript:">商城首页</a><a class="btn" href="javascript:">查看订单</a><div>',
        cancel = '<div><img src="https://img.caibeitv.com/static_project/static_image/neigou_pay_cancel.png" alt=""><h3>支付失败</h3><p>支付取消，请在待支付订单再次支付！</p><a onclick="toHome()" class="btn" href="javascript:">商城首页</a><a class="btn" href="javascript:">查看订单</a><div>',
        busy = '<div><img src="https://img.caibeitv.com/static_project/static_image/neigou_busy.png" alt=""><h3>支付失败</h3><p>服务器繁忙，请稍后再试！</p><a onclick="toHome()" class="btn" href="javascript:">商城首页</a><a class="btn" href="javascript:">查看订单</a><div>',
        success = '<div><img src="https://img.caibeitv.com/static_project/static_image/neigou_pay_success.png" alt=""><h3>支付成功</h3><p>感谢对采贝的信任，期待再次光临</p><a onclick="toHome()" class="btn" href="javascript:">商城首页</a><a class="btn" href="javascript:">查看订单</a><div>';

    if (total_fee) {
        total_fee = total_fee / 100;
    }

    var pay_fail = '<p>商品价格：￥'+ total_fee +'</p><p>需付积分：<span style="color:#4ec2fc">'+ integral_count +'</span></p>';
    var pay_success = '<p>商品价格：￥'+ total_fee +'</p><p>已付积分：<span style="color:#4ec2fc">'+ integral_count +'</span></p>';
    function resetUi(code) {
        if (code) {
            code = Number(code);
        } else {
            code = 0;
        }
        switch (code) {
            // 支付中
            case 0:
                document.title = '支付中';
                app.innerHTML = paying;
                integral.innerHTML = "";
                break;
            case 200:
                document.title = '支付成功';
                app.innerHTML = success;
                integral.innerHTML = pay_success;
                break;
                // 支付错误
            case 400:
                document.title = '支付错误';
                app.innerHTML = busy;
                integral.innerHTML = pay_fail;
                break;
                // 支付取消
            case 1050002:
                document.title = '支付取消';
                app.innerHTML = cancel;
                integral.innerHTML = pay_fail;
                break;
                // 积分不足
            case 1050003:
                getHome();
                document.title = '积分不足';
                app.innerHTML = lack;
                integral.innerHTML = pay_fail;
                break;
                // 网络错误
            case 505:
                document.title = '网络错误';
                app.innerHTML = error;
                integral.innerHTML = pay_fail;
                break;
            default:
                document.title = '支付中';
                app.innerHTML = paying;
                integral.innerHTML = "";
                break;
        }
    }

    function getHome(refresh) {
        App.httpRequest({
            url: Api.home,
            data: $data,
            type: 'get',
            success: function(res) {
                var url = res.data.url;
                homeUrl = url;
                if (refresh) {
                    window.location.href = url;
                }
                // app.innerHTML = '<div><img src="https://img.caibeitv.com/static_project/static_image/neigou_integral_lack.png" alt=""><p>积分不足，支付失败，请获取积分后再试！</p><a class="btn" href="' + url + '">返回商城</a><div>';
            },
            error: function(err) {
                alert(JSON.stringify(err));
            }
        });
    }

    function toHome() {
        alert(homeUrl);
        if (homeUrl !== "") {
            window.location.href = homeUrl;
        } else {
            getHome(1);
        }
    }

    function payAgain() {
        requestPay();
    }

    function requestPay() {
        App.httpRequest({
            url: Api.pay,
            data: $data,
            type: 'post',
            success: function(res) {
                var message, code = Number(res.code);
                if (res.hasOwnProperty('message')) {
                    message = res.message;
                }
                if (!code) {
                    if (message && message !== 'ok') {
                        code = 505;
                    }
                }
                resetUi(code);
            },
            error: function(err) {
                alert(JSON.stringify(err));
            }
        });
    }

    getHome();
    // requestPay();
    resetUi(1050002);
    </script>
</body>

</html>